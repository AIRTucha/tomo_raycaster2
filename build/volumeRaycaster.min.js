!function(a){var b=function(){var a={};return a._core={},a._possible_steps=[32,64,128,256,512,1024],a._current_steps_index=0,a._onPostDrawFuncIndex=-1,a._onCameraChangeStartFuncIndex=-1,a._onCameraChangeEndFuncIndex=-1,a.init=function(b){a._core=b,a._onPostDrawFuncIndex=a._core.onPostDraw.add(function(b){a["do"](b)}),a._onCameraChangeStartFuncIndex=a._core.onCameraChangeStart.add(function(){a.pause(!0)}),a._onCameraChangeEndFuncIndex=a._core.onCameraChangeEnd.add(function(){a.pause(!1)})},a.setPossibleSteps=function(b){a._possible_steps=b},a.run=function(b){b?(a._core.onPostDraw.Start(a._onPostDrawFuncIndex),a._core.onCameraChangeStart.Start(a._onCameraChangeEndFuncIndex),a._core.onCameraChangeEnd.Start(a._onCameraChangeStartFuncIndex)):(a._core.onPostDraw.stop(a._onPostDrawFuncIndex),a._core.onCameraChangeStart.stop(a._onCameraChangeEndFuncIndex),a._core.onCameraChangeEnd.stop(a._onCameraChangeStartFuncIndex))},a.pause=function(b){b?(a._core.onCameraChangeStart.stop(a._onCameraChangeEndFuncIndex),a._core.onPostDraw.stop(a._onPostDrawFuncIndex)):(a._core.onCameraChangeStart.Start(a._onCameraChangeEndFuncIndex),a._core.onPostDraw.Start(a._onPostDrawFuncIndex))},a.decreaseSteps=function(){a._current_steps_index--,a._core.setSteps(a.getSteps())},a.increaseSteps=function(){a._current_steps_index++,a._core.setSteps(a.getSteps())},a.getSteps=function(){return a._possible_steps[a._current_steps_index]},a.isRun=function(){var b=a._core.onPostDraw.IsRun(a._onPostDrawFuncIndex),c=a._core.onCameraChangeStart.IsRun(a._onCameraChangeEndFuncIndex),d=a._core.onCameraChangeEnd.IsRun(a._onCameraChangeStartFuncIndex);return b&&c&&d},a.isPause=function(){var b=a._core.onPostDraw.IsRun(a._onPostDrawFuncIndex),c=a._core.onCameraChangeStart.IsRun(a._onCameraChangeEndFuncIndex),d=a._core.onCameraChangeEnd.IsRun(a._onCameraChangeStartFuncIndex);return!b&&!c&&d},a["do"]=function(b){15>b&&a._current_steps_index>0?(console.log("FPS: "+b+", Number of steps: "+a.getSteps()),a.decreaseSteps()):b>40&&a._current_steps_index<a._possible_steps.length-1&&(console.log("FPS: "+b+", Number of steps: "+a.getSteps()),a.increaseSteps())},a};a.AdaptationManager=b}(window.VRC),function(a){var b=function(a){var b={};return b._steps=20,b._slices_gap=[0,"*"],b._slicemap_row_col=[16,16],b._gray_value=[0,1],b._slicemaps_images=[],b._slicemaps_textures=[],b._opacity_factor=1,b._color_factor=1,b._absorption_mode_index=0,b._render_resolution=["*","*"],b._render_clear_color="#ffffff",b._transfer_function=[],b._geometry_dimension={xmin:0,xmax:1,ymin:0,ymax:1,zmin:0,zmax:1},b._transfer_function_colors=[{pos:.25,color:"#ff0000"},{pos:.5,color:"#00ff00"},{pos:.75,color:"#0000ff"}],b._firtsPassMaterial={},b._secondPassMaterial={},b._dom_container_id=void 0!=a?a:"container",b._dom_container={},b._renderer={},b._camera={},b._camera_settings={rotation:{x:0,y:0,z:0},position:{x:0,y:0,z:2}},b._rtTexture={},b._geometry={},b._geometry_settings={rotation:{x:Math.PI,y:0,z:0},position:{x:-.5,y:-.5,z:-.5}},b._materialFirstPass={},b._materialSecondPass={},b._sceneFirstPass={},b._sceneSecondPass={},b._meshFirstPass={},b._meshSecondPass={},b.onPreDraw=new VRC.EventDispatcher,b.onPostDraw=new VRC.EventDispatcher,b.onResize=new VRC.EventDispatcher,b.onCameraChange=new VRC.EventDispatcher,b.onCameraChangeStart=new VRC.EventDispatcher,b.onCameraChangeEnd=new VRC.EventDispatcher,b._onWindowResizeFuncIndex=-1,b._shaders=new VRC.Shaders,b.init=function(){b._container=b.getDOMContainer(),b._renderer=new THREE.WebGLRenderer,b._renderer.setSize(b.getResolution()[0],b.getResolution()[1]),b._renderer.setClearColor(b._render_clear_color),b._container.appendChild(b._renderer.domElement),b._camera=new THREE.PerspectiveCamera(45,b.getResolution()[0]/b.getResolution()[1],.01,11),b._camera.position.x=b._camera_settings.position.x,b._camera.position.y=b._camera_settings.position.y,b._camera.position.z=b._camera_settings.position.z,b._camera.rotation.x=b._camera_settings.rotation.x,b._camera.rotation.y=b._camera_settings.rotation.y,b._camera.rotation.z=b._camera_settings.rotation.z,b._controls=new THREE.OrbitControls(b._camera,b._renderer.domElement),b._controls.center.set(0,0,0),b._rtTexture=new THREE.WebGLRenderTarget(b.getResolution()[0],b.getResolution()[1],{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),b._rtTexture.wrapS=b._rtTexture.wrapT=THREE.ClampToEdgeWrapping,b._materialFirstPass=new THREE.ShaderMaterial({vertexShader:b._shaders.firtsPass_vs,fragmentShader:b._shaders.firtsPass_fs,attributes:{vertColor:{type:"c",value:[]}},side:THREE.FrontSide,transparent:!0}),b._materialSecondPass=new THREE.ShaderMaterial({vertexShader:b._shaders.secondPass_vs,fragmentShader:b._shaders.secondPass_fs,attributes:{vertColor:{type:"c",value:[]}},uniforms:{uBackCoord:{type:"t",value:b._rtTexture},uSliceMaps:{type:"tv",value:b._slicemaps_textures},uTransferFunction:{type:"t",value:b._transfer_function},uSteps:{type:"f",value:b._steps},uNumberOfSlices:{type:"f",value:b.getSlicesGap()[1]},uSlicesOverX:{type:"f",value:b._slicemap_row_col[0]},uSlicesOverY:{type:"f",value:b._slicemap_row_col[1]},uOpacityVal:{type:"f",value:b._opacity_factor},uColorVal:{type:"f",value:b._color_factor},uAbsorptionModeIndex:{type:"f",value:b._absorption_mode_index},uMinGrayVal:{type:"f",value:b._gray_value[0]},uMaxGrayVal:{type:"f",value:b._gray_value[1]}},side:THREE.BackSide,transparent:!0}),b._sceneFirstPass=new THREE.Scene,b._sceneSecondPass=new THREE.Scene;var a=new GeometryHelper;b._geometry=a.createBoxGeometry(b.getGeometryDimension()),b._geometry.applyMatrix((new THREE.Matrix4).makeTranslation(b._geometry_settings.position.x,b._geometry_settings.position.y,b._geometry_settings.position.z)),b._geometry.applyMatrix((new THREE.Matrix4).makeRotationX(b._geometry_settings.rotation.x)),b._geometry.applyMatrix((new THREE.Matrix4).makeRotationY(b._geometry_settings.rotation.y)),b._geometry.applyMatrix((new THREE.Matrix4).makeRotationZ(b._geometry_settings.rotation.z)),b._geometry.doubleSided=!0,b._meshFirstPass=new THREE.Mesh(b._geometry,b._materialFirstPass),b._meshSecondPass=new THREE.Mesh(b._geometry,b._materialSecondPass),b._sceneFirstPass.add(b._meshFirstPass),b._sceneSecondPass.add(b._meshSecondPass),stats=new Stats,stats.domElement.style.position="absolute",stats.domElement.style.top="0px",container.appendChild(stats.domElement),window.addEventListener("resize",function(){b.onResize.call()},!1),b._controls.addEventListener("change",function(){b.onCameraChange.call()}),b._controls.addEventListener("start",function(){b.onCameraChangeStart.call()}),b._controls.addEventListener("end",function(){b.onCameraChangeEnd.call()}),b._transfer_function=b.setTransferFunctionByColors(b._transfer_function_colors),b._onWindowResizeFuncIndex=b.onResize.add(function(){b.setResolution("*","*")},!1)},b._secondPassSetUniformValue=function(a,c){b._materialSecondPass.uniforms[a].value=c},b._setSlicemapsTextures=function(a){for(var c=[],d=0;d<a.length;d++){var e=new THREE.Texture(a[d]);e.wrapS=e.wrapT=THREE.ClampToEdgeWrapping,e.magFilter=THREE.LinearFilter,e.minFilter=THREE.LinearFilter,e.flipY=!1,e.needsUpdate=!0,c.push(e)}b._slicemaps_textures=c},b.setTransferFunctionByImage=function(a){var c=new THREE.Texture(a);c.wrapS=c.wrapT=THREE.ClampToEdgeWrapping,c.flipY=!0,c.needsUpdate=!0,b._secondPassSetUniformValue("uTransferFunction",c)},b.setTransferFunctionByColors=function(a){var c=document.createElement("canvas");c.width=512,c.height=2;for(var d=c.getContext("2d"),e=d.createLinearGradient(0,0,c.width-1,c.height-1),f=0;f<a.length;f++)e.addColorStop(a[f].pos,a[f].color);d.fillStyle=e,d.fillRect(0,0,c.width,c.height);var g=document.getElementById("transferFunctionImg");g.src=c.toDataURL(),g.style.width="20 px",g.style.height="512 px";b.setTransferFunctionByImage(c)},b._setGeometry=function(a){var c=(new GeometryHelper).createBoxGeometry(a),d=c.attributes.vertColor.array,e=c.attributes.position.array;b._geometry.attributes.vertColor.array=d,b._geometry.attributes.vertColor.needsUpdate=!0,b._geometry.attributes.position.array=e,b._geometry.attributes.position.needsUpdate=!0,b._geometry.applyMatrix((new THREE.Matrix4).makeTranslation(b._geometry_settings.position.x,b._geometry_settings.position.y,b._geometry_settings.position.z)),b._geometry.applyMatrix((new THREE.Matrix4).makeRotationX(b._geometry_settings.rotation.x)),b._geometry.applyMatrix((new THREE.Matrix4).makeRotationY(b._geometry_settings.rotation.y)),b._geometry.applyMatrix((new THREE.Matrix4).makeRotationZ(b._geometry_settings.rotation.z)),b._geometry.doubleSided=!0},b.setSlicemapsImages=function(a){b._slicemaps_images=a,b._setSlicemapsTextures(a),b._secondPassSetUniformValue("uSliceMaps",b._slicemaps_textures),console.log("Core: setSlicemapsImages()")},b.setSteps=function(a){b._steps=a,b._secondPassSetUniformValue("uSteps",b._steps),console.log("Core: setSteps()")},b.setSlicesGap=function(a,c){b._slices_gap=[a,c],b._secondPassSetUniformValue("uNumberOfSlices",b.getSlicesGap()[1]),console.log("Core: setSlicesGap()")},b.setOpacityFactor=function(a){b._opacity_factor=a,b._secondPassSetUniformValue("uOpacityVal",b._opacity_factor),console.log("Core: setOpacityFactor()")},b.setColorFactor=function(a){b._color_factor=a,b._secondPassSetUniformValue("uColorVal",b._color_factor),console.log("Core: setColorFactor()")},b.setAbsorptionMode=function(a){b._absorption_mode_index=a,b._secondPassSetUniformValue("uAbsorptionModeIndex",b._absorption_mode_index),console.log("Core: setAbsorptionMode()")},b.setGeometryMinX=function(a){b._geometry_dimension.xmin=a,b._setGeometry(b._geometry_dimension),console.log("Core: setGeometryMinX()")},b.setGeometryMaxX=function(a){b._geometry_dimension.xmax=a,b._setGeometry(b._geometry_dimension),console.log("Core: setGeometryMaxX()")},b.setGeometryMinY=function(a){b._geometry_dimension.ymin=a,b._setGeometry(b._geometry_dimension),console.log("Core: setGeometryMinY()")},b.setGeometryMaxY=function(a){b._geometry_dimension.ymax=a,b._setGeometry(b._geometry_dimension),console.log("Core: setGeometryMaxY()")},b.setGeometryMinZ=function(a){b._geometry_dimension.zmin=a,b._setGeometry(b._geometry_dimension),console.log("Core: setGeometryMinZ()")},b.setGeometryMaxZ=function(a){b._geometry_dimension.zmax=a,b._setGeometry(b._geometry_dimension),console.log("Core: setGeometryMaxZ()")},b.setResolution=function(a,c){b._render_resolution=[a,c],("*"==b._render_resolution[0]||"*"==b._render_resolution[1])&&b.onResize.start(b._onWindowResizeFuncIndex);var a=b.getResolution()[0],c=b.getResolution()[1];"*"==b._render_resolution[0]&&(a=window.innerWidth),"*"==b._render_resolution[1]&&(c=window.innerHeight),b._camera.aspect=a/c,b._camera.updateProjectionMatrix(),b._renderer.setSize(a,c),console.log("Core: setResolution()")},b.setBackgoundColor=function(a){b._render_clear_color=a,b._renderer.setClearColor(a),console.log("Core: setBackgoundColor()")},b.setRowCol=function(a,c){b._slicemap_row_col=[a,c],b._secondPassSetUniformValue("uSlicesOverX",b._slicemap_row_col[0]),b._secondPassSetUniformValue("uSlicesOverY",b._slicemap_row_col[1]),console.log("Core: setRowCol()")},b.setGrayMinValue=function(a){b._gray_value[0]=a,b._secondPassSetUniformValue("uMinGrayVal",b._gray_value[0]),console.log("Core: setMinGrayValue()")},b.setGrayMaxValue=function(a){b._gray_value[1]=a,b._secondPassSetUniformValue("uMaxGrayVal",b._gray_value[1]),console.log("Core: setMaxGrayValue()")},b.draw=function(a){b.onPreDraw.call(a.toFixed(3)),b._renderer.render(b._sceneFirstPass,b._camera,b._rtTexture,!0),b._renderer.render(b._sceneSecondPass,b._camera),stats.update(),b.onPostDraw.call(a.toFixed(3))},b.getDOMContainer=function(){return document.getElementById(b._dom_container_id)},b.getSteps=function(){return b._steps},b.getSlicemapsImages=function(){return b._slicemaps_images},b.getRowCol=function(){return b._slicemap_row_col},b.getSlicesGap=function(){var a=b._slices_gap[0],c=b._slices_gap[1];return"*"==b._slices_gap[1]&&(c=b.getRowCol()[0]*b.getRowCol()[1]*b.getSlicemapsImages().length),[a,c]},b.getResolution=function(){var a=b._render_resolution[0],c=b._render_resolution[1];return"*"==b._render_resolution[0]&&(a=window.innerWidth),"*"==b._render_resolution[1]&&(c=window.innerHeight),[a,c]},b.getGeometryDimension=function(){return b._geometry_dimension},b.getGeometryMinX=function(){return b._geometry_dimension.xmin},b.getGeometryMaxX=function(){return b._geometry_dimension.xmax},b.getGeometryMinY=function(){return b._geometry_dimension.ymin},b.getGeometryMaxY=function(){return b._geometry_dimension.ymax},b.getGeometryMinZ=function(){return b._geometry_dimension.zmin},b.getGeometryMaxZ=function(){return b._geometry_dimension.zmax},b.getGrayMinValue=function(){return b._gray_value[0]},b.getGrayMaxValue=function(){return b._gray_value[1]},b};a.Core=b}(window.VRC),function(a){var b=function(a){var b={};return b["class"]=this,b._functions=[],b._context=window,b.add=function(a,c){return b._functions.push({is_start:void 0!=c?c:!0,func:a}),b._functions.length-1},b.remove=function(a){delete b._functions[a]},b.get=function(a){return b._functions[a]},b.stop=function(a){b._functions[a].is_start=!1},b.start=function(a){b._functions[a].is_start=!0},b.isStart=function(a){return b._functions[a].is_start},b.call=function(a,c){var c=c?c:b._context;for(i in b._functions){var d=b._functions[i];d.is_start&&d.func.call(c,a)}},b.isEmpty=function(){return 0==b._functions.length},b.setConfig=function(a){for(prop in a)switch(prop){case"context":this._context=a[prop]}},b.Constructor=function(a){this.setConfig(a)},b.Constructor(a),b};a.EventDispatcher=b}(window.VRC);var GeometryHelper=function(){return{createBoxGeometry:function(a){for(var b=[[a.xmin,a.ymin,a.zmax],[a.xmax,a.ymin,a.zmax],[a.xmax,a.ymax,a.zmax],[a.xmin,a.ymin,a.zmax],[a.xmax,a.ymax,a.zmax],[a.xmin,a.ymax,a.zmax],[a.xmin,a.ymin,a.zmin],[a.xmin,a.ymax,a.zmin],[a.xmax,a.ymax,a.zmin],[a.xmin,a.ymin,a.zmin],[a.xmax,a.ymax,a.zmin],[a.xmax,a.ymin,a.zmin],[a.xmin,a.ymax,a.zmin],[a.xmin,a.ymax,a.zmax],[a.xmax,a.ymax,a.zmax],[a.xmin,a.ymax,a.zmin],[a.xmax,a.ymax,a.zmax],[a.xmax,a.ymax,a.zmin],[a.xmin,a.ymin,a.zmin],[a.xmax,a.ymin,a.zmin],[a.xmax,a.ymin,a.zmax],[a.xmin,a.ymin,a.zmin],[a.xmax,a.ymin,a.zmax],[a.xmin,a.ymin,a.zmax],[a.xmax,a.ymin,a.zmin],[a.xmax,a.ymax,a.zmin],[a.xmax,a.ymax,a.zmax],[a.xmax,a.ymin,a.zmin],[a.xmax,a.ymax,a.zmax],[a.xmax,a.ymin,a.zmax],[a.xmin,a.ymin,a.zmin],[a.xmin,a.ymin,a.zmax],[a.xmin,a.ymax,a.zmax],[a.xmin,a.ymin,a.zmin],[a.xmin,a.ymax,a.zmax],[a.xmin,a.ymax,a.zmin]],c=[],d=[],e=0;e<b.length;e++){var f=b.length-1-e,g=b[f][0],h=b[f][1],i=b[f][2];c.push(g),c.push(h),c.push(i),d.push(g),d.push(h),d.push(i),d.push(1)}var j=new THREE.BufferGeometry,k=new Float32Array(c);return j.addAttribute("position",new THREE.BufferAttribute(k,3)),j.addAttribute("vertColor",new THREE.BufferAttribute(new Float32Array(d),4)),j.computeBoundingSphere(),j}}},GeometryDimension=function(){this.xmin=.005,this.xmax=.5,this.ymin=.005,this.ymax=.995,this.zmin=.005,this.zmax=.995}(function(a){a.VRC={}})(window);!function(a){var b=function(a){var b={};return b["class"]=this,b.firtsPass_vs=["#ifdef GL_FRAGMENT_PRECISION_HIGH","precision highp int;","precision highp float;","#else","precision mediump int;","precision mediump float;","#endif","attribute vec4 vertColor;","varying vec4 backColor;","varying vec4 pos;","void main(void)","{","    backColor = vertColor;","    pos = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","    gl_Position = pos;","}"].join("\n"),b.firtsPass_fs=["#ifdef GL_FRAGMENT_PRECISION_HIGH","    // highp is supported","    precision highp int;","    precision highp float;","#else","    // high is not supported","    precision mediump int;","    precision mediump float;","#endif","varying vec4 backColor;","void main(void)","{","    gl_FragColor = backColor;","}"].join("\n"),b.secondPass_vs=["#ifdef GL_FRAGMENT_PRECISION_HIGH","    // highp is supported","    precision highp int;","    precision highp float;","#else","    // high is not supported","    precision mediump int;","    precision mediump float;","#endif","attribute vec4 vertColor;","varying vec4 frontColor;","varying vec4 pos;","void main(void)","{","    frontColor = vertColor;","    pos = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","    gl_Position = pos;","}"].join("\n"),b.secondPass_fs=["#ifdef GL_FRAGMENT_PRECISION_HIGH","    // highp is supported","    precision highp int;","    precision highp float;","#else","    // high is not supported","    precision mediump int;","    precision mediump float;","#endif","varying vec4 frontColor;","varying vec4 pos;","uniform sampler2D uBackCoord;","uniform sampler2D uSliceMaps[10];","uniform sampler2D uTransferFunction;","uniform float uNumberOfSlices;","uniform float uMinGrayVal;","uniform float uMaxGrayVal;","uniform float uOpacityVal;","uniform float uColorVal;","uniform float uAbsorptionModeIndex;","uniform float uSlicesOverX;","uniform float uSlicesOverY;","uniform float uSteps;","//Acts like a texture3D using Z slices and trilinear filtering.","float getVolumeValue(vec3 volpos)","{","    float s1Original, s2Original, s1, s2;","    float dx1, dy1;","    float dx2, dy2;","    float value;","    vec2 texpos1,texpos2;","    float slicesPerSprite = uSlicesOverX * uSlicesOverY;","    s1Original = floor(volpos.z*uNumberOfSlices);","    s2Original = min(s1Original+1.0, uNumberOfSlices);","    int tex1Index = int(floor(s1Original / slicesPerSprite));","    int tex2Index = int(floor(s2Original / slicesPerSprite));","    s1 = mod(s1Original, slicesPerSprite);","    s2 = mod(s2Original, slicesPerSprite);","    dx1 = fract(s1/uSlicesOverX);","    dy1 = floor(s1/uSlicesOverY)/uSlicesOverY;","    dx2 = fract(s2/uSlicesOverX);","    dy2 = floor(s2/uSlicesOverY)/uSlicesOverY;","    texpos1.x = dx1+(volpos.x/uSlicesOverX);","    texpos1.y = dy1+(volpos.y/uSlicesOverY);","    texpos2.x = dx2+(volpos.x/uSlicesOverX);","    texpos2.y = dy2+(volpos.y/uSlicesOverY);","    float value1, value2;","    bool value1Set = false, value2Set = false;","    for (int x = 0; x < 10; x++) {","        if(x == tex1Index) {","            value1 = texture2D(uSliceMaps[x],texpos1).x;","            value1Set = true;","        }","        if(x == tex2Index) {","            value2 = texture2D(uSliceMaps[x],texpos2).x;","            value2Set = true;","        }","        if(value1Set && value2Set) {","            break;","        }","    }","    return mix(value1, value2, fract(volpos.z*uNumberOfSlices));","    // return value1;","}","void main(void)","{","    vec2 texC = ((pos.xy/pos.w) + 1.0) / 2.0;","    vec4 backColor = texture2D(uBackCoord,texC);","    vec3 dir = backColor.rgb - frontColor.rgb;","    vec4 vpos = frontColor;","    vec3 Step = dir/uSteps;","    vec4 accum = vec4(0, 0, 0, 0);","    vec4 sample = vec4(0.0, 0.0, 0.0, 0.0);","    vec4 color_value = vec4(0, 0, 0, 0);","    float biggest_gray_value = 0.0;","    float opacityFactor = 8.0;//uOpacityVal;","    float lightFactor = 1.3;//uColorVal;","    // const 4095 - only example of big number","    // It because expression i > uSteps impossible","    for(float i = 0.0; i < 4095.0; i+=1.0)","    {","    // It because expression i > uSteps impossible","        if(i == uSteps) {","            break;","        }","        float gray_val = getVolumeValue(vpos.xyz);","        if(gray_val < uMinGrayVal || gray_val > uMaxGrayVal) {","            color_value = vec4(0.0);","        } else {","            if(biggest_gray_value < gray_val) {","               biggest_gray_value = gray_val;","            }","            vec2 tf_pos;","            tf_pos.x = (gray_val - uMinGrayVal) / (uMaxGrayVal - uMinGrayVal);","            tf_pos.y = 0.5;","            color_value = texture2D(uTransferFunction,tf_pos); ","            // color_value = vec4(pos, pos, pos, 1.0);","            if(uAbsorptionModeIndex == 0.0)","        {","            sample.a = color_value.a * opacityFactor;","            sample.rgb = color_value.rgb * uColorVal;","            accum += sample;","            if(accum.a>=0.95)","               break;","        }","        if(uAbsorptionModeIndex == 1.0)","        {","            sample.a = color_value.a * opacityFactor * (1.0 / uSteps);","            sample.rgb = (1.0 - accum.a) * color_value.rgb * sample.a * lightFactor;","            accum += sample;","            if(accum.a>=0.95)","               break;","        }","        }","        //advance the current position","        vpos.xyz += Step;","        //break if the position is greater than <1, 1, 1>","        if(vpos.x > 1.0 || vpos.y > 1.0 || vpos.z > 1.0)","        {","            break;","        }","    }","    if(uAbsorptionModeIndex == 2.0)","    {","       if(biggest_gray_value == 0.0) {","           accum = vec4(0.0);","       } else {","            vec2 tf_pos;","            tf_pos.x = (biggest_gray_value - uMinGrayVal) / (uMaxGrayVal - uMinGrayVal);","            tf_pos.y = 0.5;","            accum = texture2D(uTransferFunction,tf_pos); ","       }","    }","    gl_FragColor = accum;","}"].join("\n"),b.Constructor=function(a){},b.Constructor(a),b};a.Shaders=b}(window.VRC),function(a){var b=function(a){var b={};return b._needRedraw=!0,b._isStart=!1,b._clock=new THREE.Clock,b._core=new VRC.Core(a.dom_container_id),b._adaptationManager=new VRC.AdaptationManager,b.init=function(){function a(){if(requestAnimationFrame(a),b._needRedraw&&b._isStart){var c=b._clock.getDelta(),d=1/c;b._core.draw(d),b._needRedraw=!1}}b._core.init(),b._adaptationManager.init(b._core),b.addOnCameraChangeCallback(function(){b._needRedraw=!0}),a()},b.setConfig=function(a){void 0!=a.gap_slices&&b._core.setSlicesGap(a.gap_slices[0],a.gap_slices[1]),void 0!=a.steps&&b._core.setSteps(a.steps),void 0!=a.row_col&&b._core.setRowCol(a.row_col[0],a.row_col[1]),void 0!=a.gray_min&&b._core.setGrayMinValue(a.gray_min),void 0!=a.gray_max&&b._core.setGrayMaxValue(a.gray_max),void 0!=a.x_min&&b._core.setGeometryMinX(a.x_min),void 0!=a.x_max&&b._core.setGeometryMaxX(a.x_max),void 0!=a.y_min&&b._core.setGeometryMinY(a.y_min),void 0!=a.y_max&&b._core.setGeometryMaxY(a.y_max),void 0!=a.z_min&&b._core.setGeometryMinZ(a.z_min),void 0!=a.z_max&&b._core.setGeometryMaxZ(a.z_max),void 0!=a.opacity_factor&&b._core.setOpacityFactor(a.opacity_factor),void 0!=a.color_factor&&b._core.setColorFactor(a.color_factor),void 0!=a.backgound&&b._core.setBackgoundColor(a.backgound),void 0!=a.auto_steps&&b.setAutoStepsOn(a.auto_steps),void 0!=a.absorption_mode&&b._core.setAbsorptionMode(a.absorption_mode),void 0!=a.resolution&&b.setResolution(a.resolution[0],a.resolution[1]),void 0!=a.slicemaps_images&&b.setSlicemapsImages(a.slicemaps_images),void 0!=a.slicemaps_paths&&b.uploadSlicemapsImages(a.slicemaps_paths,function(a){},function(a){b.start()}),b._needRedraw=!0},b.setSlicemapsImages=function(a){var c=b._core._renderer.getContext(),d=c.getParameter(c.MAX_TEXTURE_SIZE),e=a[0];if(Math.max(e.width,e.height)>d)throw Error("Size of slice bigger than maximum possible on current GPU. Maximum size of texture: "+d);b._core.setSlicemapsImages(a),b._needRedraw=!0},b.uploadSlicemapsImages=function(a,c,d,e){var f=function(a,b,c,d){var e=[],f=0;try{for(var g=0;g<a.length;g++){var h=new Image;!function(g,h){g.onload=function(){e[h]=g,f++,b(g),f==a.length&&c(e)},g.onerror=d,g.src=a[h]}(h,g)}}catch(i){d(i)}};f(a,function(a){void 0!=c&&c(a)},function(a){b.setSlicemapsImages(a),void 0!=d&&d(a)},function(a){void 0!=e?e(a):console.error(a)})},b.start=function(){b._isStart=!0},b.stop=function(){b._isStart=!1},b.setSteps=function(a){b._core.setSteps(a),b._needRedraw=!0},b.setAutoStepsOn=function(a){b._adaptationManager.run(a),b._needRedraw=!0},b.setSlicesGap=function(a,c){b._core.setSlicesGap(a,c),b._needRedraw=!0},b.setOpacityFactor=function(a){b._core.setOpacityFactor(a),b._needRedraw=!0},b.setColorFactor=function(a){b._core.setColorFactor(a),b._needRedraw=!0},b.setAbsorptionMode=function(a){b._core.setAbsorptionMode(a),b._needRedraw=!0},b.setGeometryMinX=function(a){if(a>1||0>a)throw Error("Geometry size  should be in range [0.0 - 1.0] !");if(a>b._core.getGeometryMaxX())throw Error("Min X should be lower than max X!");b._core.setGeometryMinX(a),b._needRedraw=!0},b.setGeometryMaxX=function(a){if(a>1||0>a)throw Error("Geometry size  should be in range [0.0 - 1.0] !");if(a<b._core.getGeometryMinX())throw Error("Max X should be bigger than min X!");b._core.setGeometryMaxX(a),b._needRedraw=!0},b.setGeometryMinY=function(a){if(a>1||0>a)throw Error("Geometry size  should be in range [0.0 - 1.0] !");if(a>b._core.getGeometryMaxY())throw Error("Min Y should be lower than max Y!");b._core.setGeometryMinY(a),b._needRedraw=!0},b.setGeometryMaxY=function(a){if(a>1||0>a)throw Error("Geometry size  should be in range [0.0 - 1.0] !");if(a<b._core.getGeometryMinY())throw Error("Max Y should be bigger than min Y!");b._core.setGeometryMaxY(a),b._needRedraw=!0},b.setGeometryMinZ=function(a){if(a>1||0>a)throw Error("Geometry size  should be in range [0.0 - 1.0] !");if(a>b._core.getGeometryMaxZ())throw Error("Min Z should be lower than max Z!");b._core.setGeometryMinZ(a),b._needRedraw=!0},b.setGeometryMaxZ=function(a){if(a>1||0>a)throw Error("Geometry size  should be in range [0.0 - 1.0] !");if(a<b._core.getGeometryMinZ())throw Error("Max Z should be bigger than min Z!");b._core.setGeometryMaxZ(a),b._needRedraw=!0},b.setResolution=function(a,c){var d=b._core._renderer.getContext(),e=d.getParameter(d.MAX_RENDERBUFFER_SIZE);Math.max(a,c)>e?(console.warn("Size of canvas setted in "+e+"x"+e+". Max render buffer size is "+e+"."),b._core.setResolution(e,e)):b._core.setResolution(a,c),b._needRedraw=!0},b.setBackgoundColor=function(a){b._core.setBackgoundColor(a),b._needRedraw=!0},b.setRowCol=function(a,c){b._core.setRowCol(a,c),b._needRedraw=!0},b.setGrayMinValue=function(a){if(a>1||0>a)throw Error("Gray value should be in range [0.0 - 1.0] !");if(a>b.getGrayMaxValue())throw Error("Gray min value should be lower than max value!");b._core.setGrayMinValue(a),b._needRedraw=!0},b.setGrayMaxValue=function(a){if(a>1||0>a)throw Error("Gray value should be in range [0.0 - 1.0] !");if(a<b.getGrayMinValue())throw Error("Gray max value should be bigger than min value!");b._core.setGrayMaxValue(a),b._needRedraw=!0},b.setTransferFunctionByColors=function(a){b._core.setTransferFunctionByColors(a),b._needRedraw=!0},b.setTransferFunctionByImage=function(a){b._core.setTransferFunctionByImage(a),b._needRedraw=!0},b.addOnResizeCallback=function(a){b._core.onResize.add(a),b._needRedraw=!0},b.addOnCameraChangeCallback=function(a){b._core.onCameraChange.add(a),b._needRedraw=!0},b.addOnCameraChangeStartCallback=function(a){b._core.onCameraChangeStart.add(a),b._needRedraw=!0},b.addOnCameraChangeEndCallback=function(a){b._core.onCameraChangeEnd.add(a),b._needRedraw=!0},b.addPreDraw=function(a){b._core.onPreDraw.add(a),b._needRedraw=!0},b.addOnDraw=function(a){b._core.onDraw.add(a),b._needRedraw=!0},b.getGrayMaxValue=function(){return b._core.getGrayMaxValue()},b.getGrayMinValue=function(){return b._core.getGrayMinValue()},b.draw=function(){b._core.draw()},b.init(),b.setConfig(a),b};a.VolumeRaycaster=b}(window.VRC);